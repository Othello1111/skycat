# E.S.O. - VLT project 
# "@(#) $Id: Makefile.in,v 1.2 2005/02/02 01:43:03 brighton Exp $"
#
# Component level Makefile
#
# who             when      what
# --------------  --------  ----------------------------------------
# Allan Brighton  05/12/95  Created
# pbiereic        01/03/01  Print options
#

# directories containing library sources
SUBDIRS 	= rtdevt rtilib rtdrmt rtdimg
SRC_ROOT        = @SCR_ROOT@

# directories to run make in
ALLDIRS 	= $(SUBDIRS)

# this dir
SRCDIR = @SRC_ROOT@

# library source dirs, including dependent packages
DEP_LIB_SUBDIRS	= @RTD_SUBDIRS@ $(ASTROTCL_SUBDIRS) $(TCLUTIL_SUBDIRS)

# names of master libraries to generate
LIBRARY_a 	= librtd.a
LIBRARY_sl 	= librtd@SHLIB_SUFFIX@
LIBRTD          = -lrtd

# temp dir used to generate master librtd.a
TMPDIR  	= ./tmp

# info needed for shared libraries (see configure.in or tclConfig.sh for an explanation)
SHLIB_CFLAGS=@SHLIB_CFLAGS@
SHLIB_LD=@SHLIB_LD@
SHLIB_SUFFIX=@SHLIB_SUFFIX@
SHLIB_LD_LIBS=@SHLIB_LD_LIBS@
NEED_SHLIB_LD_LIBS=@NEED_SHLIB_LD_LIBS@
DL_LIBS=@DL_LIBS@
LD_FLAGS=@LD_FLAGS@
LIB_RUNTIME_DIR=@LIB_RUNTIME_DIR@
LD_SEARCH_FLAGS=@LD_SEARCH_FLAGS@

# Tcl/Tk libraries
TCLTKLIBS = \
	@ITK_LIB_SPEC@ \
	@TK_LIB_SPEC@ \
	@BLT_LIB_SPEC@ \
	@TCLX_LIB_SPEC@ \
	@ITCL_LIB_SPEC@ \
	@TCL_LIB_SPEC@

# This flag is set to 1 by configure if a shared library should be made
SHARED  = @SHARED@

# Dependent libraries added to command line to build master shared library,
# on systems where that is needed. 
MASTER_DEP_LIBS = $(TCLTKLIBS) $(X_LIB) $(EXTRA_LIBS) @LIB_STDCPP@


# ------------------------------------------------------------------------

# make all in subdirs and generate shared lib if needed
do_all: sub master_lib

# make all in subdirs
sub:
	$(AT)for i in $(ALLDIRS); do (cd $$i; $(MAKE) all) || exit 1; done

# generate master library 
# (make .a archive and shared library, if configure --enable-shared was specified) 
# We also make a link to the shared lib in rtdimg, for testing with "package require"
# locally in the parent dir of the local Rtd library dir.
master_lib:
	$(AT)test -d tmp || mkdir tmp ; \
	 cd tmp ; \
	 $(RM) *.o .objs; \
	 for i in $(DEP_LIB_SUBDIRS); do \
	   cat $$i/src/.objs >> .objs ; \
	 done ; \
	 if test $(SHARED) -eq 1 ; then \
	   echo "making master $(LIBRARY_sl) shared library" ; \
	   test -f ../$(LIBRARY_sl) && chmod 755 ../$(LIBRARY_sl) ; \
	   if test "$(NEED_SHLIB_LD_LIBS)" = "1" ; then \
	       $(SHLIB_LD) -o ../$(LIBRARY_sl) `cat .objs` ; \
	   else \
	       $(SHLIB_LD) -o ../$(LIBRARY_sl) `cat .objs` $(MASTER_DEP_LIBS) $(LD_SEARCH_FLAGS) ; \
	   fi ; \
	   chmod 555 ../$(LIBRARY_sl) ; \
	   (cd ../rtdimg; $(RM) $(LIBRARY_sl); ln -s ../$(LIBRARY_sl) .) ; \
	 fi ; \
	 echo "making master $(LIBRARY_a) library" ; \
	 $(RM) ../$(LIBRARY_a) ; \
	 $(AR) ../$(LIBRARY_a) `cat .objs` ; \
	 $(RANLIB) ../$(LIBRARY_a) ; \
	 echo "RTD master library build on `date`" ; \

cleanup:
	$(AT)for i in $(ALLDIRS); do (cd $$i; $(MAKE) clean) done
	$(AT)$(RM) $(LIBRARY_sl) $(LIBRARY_a)

do_clean: cleanup

do_depend do_man: 
	$(AT)for i in $(SUBDIRS); do (cd $$i; $(MAKE) $@) done

do_distclean: clean
	$(AT)$(RM) config.status config.cache config.log config.h 
	$(AT)$(RM) Makefile .makelog $(TMPDIR)/*.[ao] install
	$(AT)$(RM) -r tmp
	$(AT)for i in $(SUBDIRS); do (cd $$i; $(MAKE) $@) done


# run install in the subdirs and also install header files from dependent 
# packages whose object files are included in the master library.
.PHONY: install_rtd
install_rtd: 
	$(AT)for i in $(ALLDIRS); do (cd $$i; $(MAKE) install) done
	$(AT)cp rtdConfig.sh $(LIBDIR)
	$(AT)for i in $(ASTROTCL_SUBDIRS) $(TCLUTIL_SUBDIRS) ; do \
	    if test -d $$i/include ; then \
		(cd $$i/include; $(MAKE) install INCDIR=$(INCDIR)) ;\
	    fi ; \
	done

# install master libraries (archive and shared, if requested)
# We also make a link to the shared lib in $rtd_library for "package require"
.PHONY: install_master_lib
install_master_lib: 
	$(AT)if test $(SHARED) -eq 1 ; then \
	   echo "installing master $(LIBRARY_sl)" ;\
	   $(RM) $(LIBDIR)/$(LIBRARY_sl) ;\
	   cp -f $(LIBRARY_sl) $(LIBDIR)/$(LIBRARY_sl) ;\
	   chmod 555 $(LIBDIR)/$(LIBRARY_sl) ;\
	fi 
	$(AT)cp -f $(LIBRARY_a) $(LIBDIR)/$(LIBRARY_a) 
	$(AT)$(RANLIB) $(LIBDIR)/$(LIBRARY_a)

# install everything	
do_install: install_rtd install_master_lib

include ./makefile.mk

