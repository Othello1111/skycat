# ESO/Archive
# $Id: Makefile.in,v 1.17 1999/02/04 22:12:29 abrighto Exp $
#
# Component level Makefile

# source dir used to build single binary
SKYCAT_WRAPPER_DIR = @SKYCAT_WRAPPER_DIR@

# directories to run make in
SUBDIRS = interp $(SKYCAT_WRAPPER_DIR)

# this dir
SRCDIR = @SRC_ROOT@

# library source dirs, including dependent packages
DEP_LIB_SUBDIRS	= $(SRCDIR)/interp

# make libskycat.so from these dirs
LIBDIRS = interp

# run "make clean" in these dirs
CLEANDIRS = $(LIBDIRS) $(SKYCAT_WRAPPER_DIR)

# names of master libraries to generate
LIBRARY_a 	= libskycat.a
LIBRARY_sl 	= libskycat@SHLIB_SUFFIX@

# temp dir used to generate master lib
TMPDIR  	= ./tmp

# install dirs
LIBDIR  	= @LIBDIR@
TOPDIR	        = @DESTDIR@
BINDIR          = @BINDIR@

# install programs
INSTALL  	= @INSTALL@
INSTALL_DATA  	= @INSTALL_DATA@
RANLIB   	= @RANLIB@
SHELL    	= /bin/sh
AR       	= ar rc
RM       	= rm -f

# misc system libs
EXTRA_LIBS   = @LIBS@
LIBS         = @LIBS@
X_LIB        = @XLIBSW@

# info needed for shared libraries (see configure.in or tclConfig.sh for an explanation)
SHLIB_CFLAGS=@SHLIB_CFLAGS@
SHLIB_LD=@SHLIB_LD@
SHLIB_SUFFIX=@SHLIB_SUFFIX@
SHLIB_LD_LIBS=@SHLIB_LD_LIBS@
DL_LIBS=@DL_LIBS@
LD_FLAGS=@LD_FLAGS@
LD_SEARCH_FLAGS=@LD_SEARCH_FLAGS@
LIB_RUNTIME_DIR=$(LIBDIR)

# tcl/tk and related libraries
TCLTKLIBS = \
	@ITK_LIB_SPEC@ \
	@TK_LIB_SPEC@ \
	@BLT_LIB_SPEC@ \
	@TCLX_LIB_SPEC@ \
	@ITCL_LIB_SPEC@ \
	@TCL_LIB_SPEC@

# catalog lib
CAT_LIB = @CAT_LIB@
CAT_LIB_STATIC = @CAT_LIB_STATIC@

# rtd lib
RTD_LIB = @RTD_LIB@
RTD_LIB_STATIC = @RTD_LIB_STATIC@

# This flag is set to 1 by configure if a shared library should be made
SHARED  = @SHARED@

# Dependent libraries added to command line to build master shared library,
# on systems where that is needed. 
MASTER_DEP_LIBS = $(TCLTKLIBS) $(X_LIB) $(EXTRA_LIBS)

# -------------------------------------------------------------------------
# make all in subdirs and generate shared lib if needed
all: src master_lib bin

# build local sources
src: FORCE
	(cd interp; echo "interp:"; $(MAKE) all)

# make single binary version
bin: FORCE
	test -d "$(SKYCAT_WRAPPER_DIR)" \
	  && (cd $(SKYCAT_WRAPPER_DIR); echo "$(SKYCAT_WRAPPER_DIR):"; $(MAKE) all)

# generate master library
master_lib: FORCE
	test -d tmp || mkdir tmp
	- cd tmp ;\
	 rm -f *.o ;\
	 for i in $(DEP_LIB_SUBDIRS); do \
	   cp `cat $$i/src/.objs` . ; \
	 done ;\
	 ar x $(CAT_LIB_STATIC) ;\
	 ar x $(RTD_LIB_STATIC) ;\
	 if test $(SHARED) -eq 1 ; then \
	   echo "making master $(LIBRARY_sl) shared library" ;\
	   test -f ../$(LIBRARY_sl) && chmod 755 ../$(LIBRARY_sl) ;\
	   if test "$(SHLIB_LD_LIBS)" = "" ; then \
	       $(SHLIB_LD) -o ../$(LIBRARY_sl) *.o ;\
	   else \
	       $(SHLIB_LD) -o ../$(LIBRARY_sl) *.o $(MASTER_DEP_LIBS) ;\
	   fi ;\
	   chmod 555 ../$(LIBRARY_sl) ;\
	   (cd ../interp; rm -f $(LIBRARY_sl); ln -s ../$(LIBRARY_sl) .) ;\
	 fi ;\
	 echo "making master $(LIBRARY_a) library" ;\
	 rm -f ../$(LIBRARY_a) ;\
	 $(AR) ../$(LIBRARY_a) *.o ;\
	 $(RANLIB) ../$(LIBRARY_a) ;\
	 rm -f *.o

clean:
	for i in $(CLEANDIRS); do (cd $$i; echo "$$i:"; $(MAKE) $@) done
	rm -f $(LIBRARY_sl) $(LIBRARY_a)

depend man: FORCE
	for i in $(SUBDIRS); do (cd $$i; echo "$$i:"; $(MAKE) $@) done

distclean: clean
	rm -f config.status config.cache config.log config.h 
	rm -f Makefile .makelog $(TMPDIR)/*.[ao] install
	for i in $(CLEANDIRS); do (cd $$i; echo "$$i:"; $(MAKE) $@) done

# run install in the subdirs
install_skycat: FORCE
	for i in $(SUBDIRS); do (cd $$i; echo "$$i:"; $(MAKE) install) done
	cp skycatConfig.sh $(LIBDIR)

# install master libraries (archive and shared, if requested)
install_master_lib: FORCE
	@if test $(SHARED) -eq 1 ; then \
	   echo "installing master $(LIBRARY_sl)" ;\
	   rm -f $(LIBDIR)/$(LIBRARY_sl) ;\
	   cp $(LIBRARY_sl) $(LIBDIR)/$(LIBRARY_sl) ;\
	   chmod 555 $(LIBDIR)/$(LIBRARY_sl) ;\
	   (cd $(LIBDIR)/skycat; rm -f $(LIBRARY_sl); ln -s ../$(LIBRARY_sl) .) ;\
	fi 
	cp $(LIBRARY_a) $(LIBDIR)/$(LIBRARY_a) 
	$(RANLIB) $(LIBDIR)/$(LIBRARY_a)

# install everything	
install: install_skycat install_master_lib

FORCE:
